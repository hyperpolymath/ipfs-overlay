# SPDX-License-Identifier: AGPL-3.0-or-later
apiVersion: v1
kind: ConfigMap
metadata:
  name: ipfs-config
  namespace: ipfs-system
data:
  ipfs-config.json: |
    {
      "Bootstrap": [],
      "Addresses": {
        "Swarm": [
          "/ip4/0.0.0.0/tcp/4001",
          "/ip6/::/tcp/4001"
        ],
        "API": "/ip4/0.0.0.0/tcp/5001",
        "Gateway": "/ip4/0.0.0.0/tcp/8080"
      },
      "Swarm": {
        "AddrFilters": null,
        "DisableBandwidthMetrics": false,
        "DisableNatPortMap": true,
        "ConnMgr": {
          "Type": "basic",
          "LowWater": 50,
          "HighWater": 200,
          "GracePeriod": "20s"
        }
      },
      "Discovery": {
        "MDNS": {
          "Enabled": false
        }
      },
      "Routing": {
        "Type": "none"
      },
      "Datastore": {
        "StorageMax": "10GB",
        "StorageGCWatermark": 90,
        "GCPeriod": "1h"
      },
      "Experimental": {
        "FilestoreEnabled": true,
        "UrlstoreEnabled": true,
        "ShardingEnabled": true
      }
    }

  init-ipfs.sh: |
    #!/bin/sh
    set -e

    echo "Initializing IPFS node..."

    if [ ! -d "/data/ipfs" ]; then
      ipfs init --profile server
      echo "IPFS initialized"
    else
      echo "IPFS already initialized"
    fi

    # Copy swarm key
    if [ -f "/etc/ipfs/swarm.key" ]; then
      cp /etc/ipfs/swarm.key /data/ipfs/swarm.key
      echo "Swarm key installed"
    fi

    # Apply configuration
    if [ -f "/etc/ipfs/ipfs-config.json" ]; then
      ipfs config replace /etc/ipfs/ipfs-config.json
      echo "Configuration applied"
    fi

    # Set up bootstrap peers
    ipfs bootstrap rm --all
    echo "Bootstrap peers cleared (private swarm)"

    echo "IPFS node ready"
